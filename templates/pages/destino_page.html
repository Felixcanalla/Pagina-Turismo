{% extends "base.html" %}
{% load wagtailcore_tags wagtailimages_tags %}

{% block extra_head %}
  {% include "partials/jsonld_breadcrumbs.html" %}
  {% include "partials/jsonld_destination.html" %}
  {# {% include "partials/jsonld_faq.html" %} #}
{% endblock %}

{% block content %}
<article class="container">

  <header class="hero {% if not page.hero_image %}hero--noimg{% endif %}">
    {% if page.hero_image %}
      {% image page.hero_image fill-1600x700 class="hero-img" %}
    {% endif %}

    <div class="hero-content">
      <nav class="breadcrumbs" aria-label="Breadcrumb">
        <ol>
          <li><a href="/">Inicio</a></li>
          {% if breadcrumb_ancestors %}
            {% for ancestor in breadcrumb_ancestors %}
              {% if ancestor.url != "/" %}
                <li><a href="{{ ancestor.url }}">{{ ancestor.title }}</a></li>
              {% endif %}
            {% endfor %}
          {% endif %}
          <li aria-current="page">{{ page.title }}</li>
        </ol>
      </nav>

      <h1>{{ page.title }}</h1>
      {% if page.intro %}<p class="muted">{{ page.intro }}</p>{% endif %}

      {% if page.tags.all|length %}
        <div class="tags">
          {% for t in page.tags.all %}
            <span class="tag">{{ t.name }}</span>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </header>

  <div class="post__content">

    {% if toc %}
      <nav class="toc" aria-label="Tabla de contenidos">
        <h3 class="toc__title">Contenido</h3>
        <ul class="toc__list">
          {% for item in toc %}
            <li class="toc__item">
              <a class="toc__link" href="#{{ item.anchor|escape }}">{{ item.title|escape }}</a>
            </li>
          {% endfor %}
        </ul>
      </nav>
    {% endif %}

    <div class="content post__body">
      {% if body_html %}
        {{ body_html|safe }}
      {% elif page.body %}
        {# Fallback: render tradicional de bloques #}
        {% for block in page.body %}
          {% include_block block %}
        {% endfor %}
      {% else %}
        <p class="muted">Este destino todavía no tiene contenido publicado.</p>
      {% endif %}
    </div>

  </div>

  {% if ctas %}
    <section class="cta-stack">
      <h2>Recomendaciones para tu viaje</h2>

      {% if ctas_source == "manual" %}
        {% for block in ctas %}
          {% include_block block %}
        {% endfor %}
      {% else %}
        {% for cta in ctas %}
          {% include "partials/cta_button.html" with url=cta.url text=cta.button_text note=cta.note %}
        {% endfor %}
      {% endif %}
    </section>
  {% endif %}

  {# ✅ FAQ (StreamField) #}
  {% if page.faq %}
    <section class="faq">
      {% for block in page.faq %}
        {% if block.block_type == "faq" %}
          <h2>{{ block.value.title|default:"Preguntas frecuentes" }}</h2>

          {% for item in block.value.items %}
            <details class="faq-item">
              <summary>{{ item.question }}</summary>
              <div class="faq-answer">
                {{ item.answer|richtext }}
              </div>
            </details>
          {% endfor %}
        {% endif %}
      {% endfor %}
    </section>
  {% endif %}

  {# ✅ Guías relacionadas a este destino (reverse del Orderable) #}
  {% with rels=page.articulos_relacionados.all %}
    {% if rels.count %}
      <section class="related">
        <h2>Guías para este destino</h2>
        <ul>
          {% for rel in rels %}
            {% if rel.articulo %}
              <li><a href="{{ rel.articulo.url }}">{{ rel.articulo.title }}</a></li>
            {% endif %}
          {% endfor %}
        </ul>
      </section>
    {% endif %}
  {% endwith %}

  {# ✅ Destinos relacionados (por tags/hermanos) #}
  {% if related_destinos %}
    <section class="related">
      <h2>Otros destinos que te pueden gustar</h2>

      <div class="grid">
        {% for d in related_destinos %}
          <a class="card" href="{{ d.url }}">
            {% if d.hero_image %}
              {% image d.hero_image fill-600x350 class="card-img" %}
            {% endif %}

            <div class="card-body">
              <h3>{{ d.title }}</h3>
              {% if d.intro %}<p class="muted">{{ d.intro }}</p>{% endif %}
            </div>
          </a>
        {% endfor %}
      </div>
    </section>
  {% endif %}

</article>
{% endblock %}